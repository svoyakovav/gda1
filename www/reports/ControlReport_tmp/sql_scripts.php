<?php
	//2018-03-26 elt исключение из строки Прочее контейнеров и платформ №373
	
	//837 = GОП; 164 = G75; 167 = G77; 170 = G78; 516 = 470
	$Org = "NVL(TO_CHAR(REF036.ORGANIZATION_OEBS_ID), CASE WHEN (HR003.CODE IN ('837', '164', '167', '170')) THEN '516' ELSE HR003.CODE END)";
	
	$Owner = "
		CASE WHEN
			(XX_USER.CUSTOMER_PKG.CHECK_PARTY_CURRENT(NVL2(CAR.CARD_HISTORY_ID, CCH.CNT001_OWNER_ID, CAR.CAR_OWNER_ID)) = 1) OR -- СОБСТВЕННИК = КУАЗОТ
			(NVL2(CAR.CARD_HISTORY_ID, CCH.CAR002_ID, CAR.CAR_GROUP_ID) = 1) -- ГРУППА = АРЕНДА
		THEN 
			CASE WHEN
				(CAR.CAR_TYPE_ID = 12) AND
				(MS003.REF035_ID = 1) AND
				($Org = 195)
			THEN 'ССКЛ' ELSE 'СОБ' END
		ELSE 'ЧУЖ' END";
	
	$ContTypeId = "CASE WHEN (UPPER(NSI014.TYPE_NAME) LIKE '%ЦИСТ%') THEN 880 ELSE 881 END";
	$ContTypeName = "CASE WHEN (UPPER(NSI014.TYPE_NAME) LIKE '%ЦИСТ%') THEN 'КЦ' ELSE 'Контейнера' END";
	
	$ProductCategory = "
		CASE
			WHEN NSI008.NAME LIKE '%СУЛЬФАТ%' THEN 54
			WHEN NSI008.NAME = 'КАПРОЛАКТАМ' THEN 51
			WHEN NSI008.NAME LIKE '%КАРБАМИД%' THEN 50
			WHEN NSI008.NAME = 'ПРОЧИЕ ПОЛИМЕРЫ' THEN 52
			WHEN NSI008.NAME LIKE '%СЕЛИТРА%' THEN 49
			WHEN NSI008.NAME LIKE '%ТКАНИ%' THEN 53
			WHEN NSI008.NAME LIKE '%АММИАК-РАСТВОРЫ В ВОДЕ%' THEN 42
			WHEN NSI008.NAME LIKE '%АММИАК БЕЗВОДНЫЙ%' THEN 41
			WHEN NSI008.NAME = 'УДОБРЕНИЯ АЗОТНЫЕ ЖИДКИЕ' THEN 46
			WHEN NSI008.NAME LIKE '%АРГОН%' THEN 44
			WHEN NSI008.NAME = 'МАСЛО ПОД' THEN 55
			WHEN NSI008.NAME = 'РАСТВОРИТЕЛЬ СФПК' THEN 101
			WHEN NSI008.NAME = 'ЦИКЛОГЕКСАНОЛ' THEN 60
			WHEN NSI008.NAME = 'ЦИКЛОГЕКСАНОН' THEN 59
			WHEN NSI008.NAME LIKE '%ЦИКЛОГЕКСАН%' THEN 58
			WHEN NSI008.NAME LIKE '%ЩЕЛОЧНОЙ СТОК%' THEN 43
			ELSE 666 END
		";
	
	$RawCategory = "
		CASE
			WHEN FIRST_NSI008.NAME = 'БЕНЗОЛ' THEN 45
			WHEN FIRST_NSI008.NAME = 'ФЕНОЛ РАСПЛАВЛЕННЫЙ' THEN 501
			WHEN FIRST_NSI008.NAME = 'ОЛЕУМ' THEN 56
			WHEN FIRST_NSI008.NAME = 'КИСЛОТА СЕРНАЯ' THEN 57
			WHEN FIRST_NSI008.NAME LIKE '%НАТРИЯ ГИДРОКСИД%' THEN 502
			WHEN FIRST_NSI008.NAME LIKE '%МАГНЕЗИТ%' THEN 48
			ELSE 666 END
		";
	
	$sql_script01 = "
		SELECT
			CAR.CAR_NUMBER,
			TO_CHAR(NVL(MS003.WEIGHT_FREIGHT, 0), '999G999G990D999') AS CARGO_WEIGHT_NETTO,
			NSI008.NAME AS CARGO_ETSNG_NAME,
			NULL AS CARGO_FULL_NAME,
			FIRST_NSI008.NAME AS FCARGO_ETSNG_NAME,
			
			TO_CHAR(NVL(FIRST_MS002.WEIGHT_FREIGHT, 0), '999G999G990D999') AS FCARGO_WEIGHT_NETTO,
			OUTER_NSI005.SHORT_NAME AS DEPARTURE_STATION_NAME,
			OUTER_OP030.SENDER_NAME AS SHIPPER_NAME,
			TO_CHAR(CAR.COMING_DATE, 'DD.MM.YYYY HH24:MI') AS COMING_DATE,
			
			-- ########## --
			MS003.SENDING_DIR AS CAR_WALKING_ID,
			CAR.CAR_TYPE_ID,
			NULL AS ACTION_TYPE,
			CASE WHEN (NVL(MS003.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS WEIGHT_SIGN,
			CASE WHEN (NVL(FIRST_MS002.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS FWEIGHT_SIGN,
			$Org AS ORGANIZATION_ID,
			$Owner AS CAR_OWNER_SIGN,
			'CAR' AS UNIT_TYPE_CODE,
			NVL(MS003.REF036_ID, NVL(MS050.REF036_ID, $ProductCategory)) AS CARGO_CATEGORY_ID,
			$RawCategory AS FCARGO_CATEGORY_ID,
			NULL AS UNIT_LENGTH
		FROM (
			SELECT
				CAR001.CAR_NUMBER,
				CAR001.ID AS CAR_ID,
				MS012.MS001_FIRST_ID,
				MS012.BEGTIME AS COMING_DATE,
				REF031.REF029_ID AS CAR_TYPE_ID,
				CAR001.CNT001_OWNER_ID AS CAR_OWNER_ID,
				CAR001.CAR002_ID AS CAR_GROUP_ID,
				(SELECT MAX(MS021.OP004_ID)
				 FROM ASUTL.MS021_CAR_DOCS MS021
				 WHERE MS021.MS012_ID = MS012.ID
				   AND MS021.IS_EXT_DOC = 1) AS OUTER_INVOICE_ID,
				(SELECT MIN(CCH.HISTORY_ID)
				 FROM XX_USER.XX_CAR_CARD_HISTORY CCH
				 WHERE CCH.UPDATE_DATE >= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND CCH.CAR001_ID = MS012.CAR001_ID) AS CARD_HISTORY_ID,
				(SELECT MAX(MS052.MS050_ID) KEEP(DENSE_RANK LAST ORDER BY MS052.BEGTIME)
				 FROM ASUTL.MS052_TASK_STRS MS052
				 WHERE MS052.BEGTIME >= MS012.BEGTIME
				   AND MS052.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS052.CAR001_ID = MS012.CAR001_ID) AS DAILY_TASK_ID,
				(SELECT MAX(MS002.MS001_ID)
				 FROM ASUTL.MS002_OP_STRS MS002
				 WHERE MS002.ENDTIME >= MS012.BEGTIME
				   AND MS002.ENDTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS002.CAR001_ID = MS012.CAR001_ID) AS LAST_ACTION_HEADER_ID
			FROM ASUTL.MS012_CAR_LIFE_CYCLE MS012
			INNER JOIN ASUTL.CAR001_CARS CAR001 ON CAR001.ID = MS012.CAR001_ID
			LEFT JOIN ASUTL.NSI107_CAR_KIND NSI107 ON NSI107.ID = CAR001.NSI107_ID
			LEFT JOIN ASUTL.REF031_REF029_NSI107 REF031 ON REF031.NSI107_ETRAN_ID = NSI107.ETRAN_ID
			WHERE MS012.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
			  AND MS012.ENDTIME >= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
			  AND NVL(REF031.REF029_ID, 0) = NVL($UnitType, NVL(REF031.REF029_ID, 0))
		) CAR
		-- ########## --
		INNER JOIN ASUTL.MS002_OP_STRS FIRST_MS002 ON FIRST_MS002.MS001_ID = CAR.MS001_FIRST_ID AND FIRST_MS002.CAR001_ID = CAR.CAR_ID
		LEFT JOIN ASUTL.NSI008_FREIGHT FIRST_NSI008 ON FIRST_NSI008.ID = FIRST_MS002.NSI008_ID
		-- ########## --
		LEFT JOIN ASUTL.OP030_INVOICE OUTER_OP030 ON OUTER_OP030.ID = CAR.OUTER_INVOICE_ID
		LEFT JOIN ASUTL.NSI005_STATION OUTER_NSI005 ON OUTER_NSI005.ID = OUTER_OP030.NSI005_FROMSTATION_ID
		-- ########## --
		INNER JOIN ASUTL.MS003_CAR_STATE_HISTORY MS003 ON MS003.CAR001_ID = CAR.CAR_ID AND MS003.MS001_ID = CAR.LAST_ACTION_HEADER_ID AND MS003.MS001_STATUS = 2
		LEFT JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = MS003.NSI008_ID
		LEFT JOIN XX_USER.XX_CAR_CARD_HISTORY CCH ON CCH.HISTORY_ID = CAR.CARD_HISTORY_ID
		LEFT JOIN ASUTL.REF036_CAT_FREIGHT_LOAD REF036 ON REF036.ID = MS003.REF036_ID
		LEFT JOIN ASUTL.MS050_TASKS MS050 ON MS050.ID = CAR.DAILY_TASK_ID
		LEFT JOIN ASUTL.HR003_DEPTS HR003 ON HR003.ID = MS050.HR003_ID
		
		UNION ALL
		
		SELECT
   		    LN.CONT_NUMBER as CONT_NUMBER,
			TO_CHAR(NVL(MS032.WEIGHT_FREIGHT, 0), '999G999G990D999') AS CARGO_WEIGHT_NETTO, 
			NSI008.NAME AS CARGO_ETSNG_NAME,
			REF020.NAME AS CARGO_FULL_NAME,
			FIRST_NSI008.NAME AS FCARGO_ETSNG_NAME,
			
			TO_CHAR(NVL(FIRST_MS031.WEIGHT_FREIGHT, 0), '999G999G990D999') AS FCARGO_WEIGHT_NETTO,
			OUTER_NSI005.SHORT_NAME AS DEPARTURE_STATION_NAME,
			OUTER_OP030.SENDER_NAME AS SHIPPER_NAME,
			TO_CHAR(LN.COMING_DATE, 'DD.MM.YYYY HH24:MI') AS COMING_DATE,
			
			-- ########## --
			NULL AS CONT_WALKING_ID,
			LN.CONT_TYPE_ID,
			NULL AS ACTION_TYPE,
			CASE WHEN (NVL(MS032.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS WEIGHT_SIGN,
			CASE WHEN (NVL(FIRST_MS031.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS FWEIGHT_SIGN,
			NULL AS ORGANIZATION_ID,
			CASE WHEN (XX_USER.CUSTOMER_PKG.CHECK_PARTY_CURRENT(LN.CONT_OWNER_ID) = 1) THEN 'СОБ' ELSE 'ЧУЖ' END AS CONT_OWNER_SIGN,
			'CONT' AS UNIT_TYPE_CODE,
			NVL(MS032.REF036_ID, $ProductCategory) AS CARGO_CATEGORY_ID,
			$RawCategory AS FCARGO_CATEGORY_ID,
			LN.UNIT_LENGTH
		FROM (
			SELECT
				CAR025.CONT_NUMBER,
				CAR025.ID AS CONT_ID,
				MS033.MS030_FIRST_ID,
				MS033.BEGTIME AS COMING_DATE,
				$ContTypeId AS CONT_TYPE_ID,
				CAR025.CNT001_ID AS CONT_OWNER_ID,
				NSI015.WIDTH_F AS UNIT_LENGTH,
				(SELECT MAX(MS038.OP004_ID)
				 FROM ASUTL.MS038_CONT_DOCS MS038
				 WHERE MS038.MS033_ID = MS033.ID
				   AND MS038.IS_EXT_DOC = 1) AS OUTER_INVOICE_ID,
				(SELECT MAX(MS037.ID)
				 FROM ASUTL.MS037_CONT_FREIGHT_HISTS MS037
				 WHERE MS037.BEGTIME >= MS033.BEGTIME
				   AND MS037.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS037.CAR025_ID = CAR025.ID) AS FREIGHT_LINE_ID,
				(SELECT MAX(MS032.ID)
				 FROM ASUTL.MS032_CONT_STATE_HISTORY MS032
				 WHERE MS032.BEGTIME >= MS033.BEGTIME
				   AND MS032.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS032.MS030_STATUS = 2
				   AND MS032.CAR025_ID = CAR025.ID) AS LAST_HISTORY_ID
			FROM ASUTL.MS033_CONT_LIFE_CYCLE MS033
			INNER JOIN ASUTL.CAR025_CONTAINERS CAR025 ON CAR025.ID = MS033.CAR025_ID
			INNER JOIN ASUTL.NSI014_CONT_TYPE_BIG NSI014 ON NSI014.ID = CAR025.NSI014_ID
			LEFT JOIN ASUTL.NSI015_CONT_SIZE_BIG NSI015 ON NSI015.ID = CAR025.NSI015_ID
			WHERE MS033.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
			  AND MS033.ENDTIME >= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
		) LN
		-- ########## --
		INNER JOIN ASUTL.MS031_CONT_OP_STRS FIRST_MS031 ON FIRST_MS031.MS030_ID = LN.MS030_FIRST_ID AND FIRST_MS031.CAR025_ID = LN.CONT_ID
		LEFT JOIN ASUTL.NSI008_FREIGHT FIRST_NSI008 ON FIRST_NSI008.ID = FIRST_MS031.NSI008_ID
		-- ########## --
		LEFT JOIN ASUTL.OP030_INVOICE OUTER_OP030 ON OUTER_OP030.ID = LN.OUTER_INVOICE_ID
		LEFT JOIN ASUTL.NSI005_STATION OUTER_NSI005 ON OUTER_NSI005.ID = OUTER_OP030.NSI005_FROMSTATION_ID
		-- ########## --
		INNER JOIN ASUTL.MS032_CONT_STATE_HISTORY MS032 ON MS032.ID = LN.LAST_HISTORY_ID
		LEFT JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = MS032.NSI008_ID
		-- ########## --
		LEFT JOIN ASUTL.MS037_CONT_FREIGHT_HISTS MS037 ON MS037.ID = LN.FREIGHT_LINE_ID
		LEFT JOIN ASUTL.REF020_ENTERPRISE_FREIGHT REF020 ON REF020.ID = MS037.REF020_ID
		-- ########## --
		WHERE LN.CONT_TYPE_ID = NVL($UnitType, LN.CONT_TYPE_ID)
    ";
	
	/*
	REF025_ID - Технологическое состояние (27 - Прибыл к перевозчику; 40 - Подан, в простое)
	TRANSFER_TP - Тип суточного (0 - Внешняя; 2 - Склад)
	REF012_ID - Тип операции (101 - Прием состава к перевозке)
	REF035_ID - Вагонная разметка (81 - БРАК; 62 - ЭК; 63 - РФ; 64 - КБШ; 1 - На погрузку)
	REF060_ID - Конт. разметка
	*/
	/*
	CASE WHEN (NVL(MS003.WEIGHT_FREIGHT, 0) > 0)
		THEN CASE WHEN (CAR.FREIGHT_LINE_ID IS NOT NULL) THEN 1 ELSE 2 END -- 1 = Загружен продукцией; 2 = Загружен сырьем
		ELSE CASE WHEN (MS003.REF035_ID IN (1, 62, 63, 64, 81)) THEN 0 ELSE 3 END -- 0 = Порожний нужный; 3 = Порожний прочее
		END AS WEIGHT_SIGN,
	---------------
	CASE WHEN (NVL(MS032.WEIGHT_FREIGHT, 0) > 0)
	THEN CASE WHEN (LN.FREIGHT_LINE_ID IS NOT NULL) THEN 1 ELSE 55 END -- 1 = ЗАГРУЖЕН ПРОДУКЦИЕЙ; 55 = ЗАГРУЖЕН СЫРЬЕМ
	ELSE 0 END AS WEIGHT_SIGN,
	*/
	
	$sql_script03 = "
		SELECT
			CAR.CAR_NUMBER,
			REF009.NAME AS FRONT_NAME,
			NSI008.NAME AS CARGO_ETSNG_NAME,
			REF020.NAME AS CARGO_FULL_NAME,
			TO_CHAR(NVL(MS003.WEIGHT_FREIGHT, 0), '999G999G990D999') AS CARGO_WEIGHT_NETTO,
			NSI005.SHORT_NAME AS DESTINATION_STATION_NAME,
			TO_CHAR(MS002.ENDTIME, 'DD.MM.YYYY HH24:MI') AS LOADING_DATE,
			TO_CHAR(CAR.COMING_DATE, 'DD.MM.YYYY HH24:MI') AS COMING_DATE,
			TO_CHAR(MS003.BEGTIME, 'DD.MM.YYYY HH24:MI') AS ACTION_DATE,
			TO_CHAR(CAR.PREPARE_DATE, 'DD.MM.YYYY HH24:MI') AS PREPARE_DATE,
			MS050.NOTES AS DAILY_TASK_NOTE,
			NVL2(CAR.CARD_HISTORY_ID, CCH.NOTE, CAR.CAR_ONE_NOTE) AS UNIT_ONE_NOTE,
			CAR.DAILY_TASK_ID,
			CNT001.CODE AS UNIT_OWNER_NAME,
			TO_CHAR(NVL(CAR.UNIT_VOLUME, 0), '999G999G990D999') AS UNIT_VOLUME,
			(SELECT XX_USER.XXT_STRAGG(DISTINCT ' ' || NSI038.FULL_NAME)
			 FROM ASUTL.MS019_CAR_COMM_FLT_HISTS MS019
			 INNER JOIN ASUTL.NSI038_CAUSE_CAR_REJECTION NSI038 ON NSI038.ID = MS019.NSI038_ID
			 WHERE MS019.MS002_ID = CAR.SPOIL_LINE_ID) AS FLAW_NAME,
			(SELECT XX_USER.XXT_STRAGG(DISTINCT ' ' || NSI001.FULL_NAME)
			 FROM ASUTL.MS018_CAR_TECH_FLT_HISTS MS018
			 INNER JOIN ASUTL.NSI001_CAR_FAULTINESS NSI001 ON NSI001.ID = MS018.NSI001_ID
			 WHERE MS018.MS002_ID = CAR.SPOIL_LINE_ID) AS FAULT_NAME,
			FIRST_NSI008.NAME AS FCARGO_ETSNG_NAME,
			
			TO_CHAR(NVL(FIRST_MS002.WEIGHT_FREIGHT, 0), '999G999G990D999') AS FCARGO_WEIGHT_NETTO,
			OUTER_NSI005.SHORT_NAME AS DEPARTURE_STATION_NAME,
			OUTER_OP030.SENDER_NAME AS SHIPPER_NAME,
			TO_CHAR(CAR.UNLOADING_DATE, 'DD.MM.YYYY HH24:MI') AS UNLOADING_DATE,
			
			-- ########## --
			MS003.SENDING_DIR AS CAR_WALKING_ID,
			CAR.CAR_TYPE_ID,
			CASE WHEN (NVL(MS003.WEIGHT_FREIGHT, 0) > 0)
				THEN CASE
						WHEN (MS003.REF025_ID = 40) THEN 'ПОД_ВЫГР'
						WHEN (MS003.REF025_ID = 27) THEN 'СДАЧА'
						WHEN (MS050.TRANSFER_TP = 0) AND (MS003.REF025_ID != 27) AND (MS001.REF012_ID != 101) THEN 'С_ДОК'
						WHEN (MS050.TRANSFER_TP = 2) AND (MS003.REF025_ID != 27) AND (MS001.REF012_ID != 101) THEN 'СКЛАД'
						ELSE NULL END
				ELSE CASE
						WHEN (MS003.REF035_ID = 81) THEN 'БРАК'
						WHEN (CAR.DAILY_TASK_ID IS NOT NULL) AND (MS003.REF025_ID = 40) THEN 'ПОД_ПОГР'
						WHEN (CAR.PREPARE_DATE IS NOT NULL) AND (MS003.REF025_ID != 40) THEN 'ГОТ_ПОГР'
						WHEN (CAR.PREPARE_DATE IS NULL) AND (MS003.REF035_ID IN (1, 62, 63, 64)) THEN 'В_ОТСТ'
						ELSE NULL END
				END AS ACTION_TYPE,
			CASE WHEN (NVL(MS003.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS WEIGHT_SIGN,
			CASE WHEN (NVL(FIRST_MS002.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS FWEIGHT_SIGN,
			$Org AS ORGANIZATION_ID,
			$Owner AS CAR_OWNER_SIGN,
			'CAR' AS UNIT_TYPE_CODE,
			NVL(MS003.REF036_ID, NVL(MS050.REF036_ID, $ProductCategory)) AS CARGO_CATEGORY_ID,
			$RawCategory AS FCARGO_CATEGORY_ID,
			NULL AS UNIT_LENGTH
		FROM (
			SELECT
				CAR001.CAR_NUMBER,
				CAR001.ID AS CAR_ID,
				MS012.MS001_FIRST_ID,
				REF031.REF029_ID AS CAR_TYPE_ID,
				CAR001.CNT001_OWNER_ID AS CAR_OWNER_ID,
				CAR001.CAR002_ID AS CAR_GROUP_ID,
				CAR001.NOTE AS CAR_ONE_NOTE,
				MS012.BEGTIME AS COMING_DATE,
				CAR001.VOLUME AS UNIT_VOLUME,
				(SELECT MAX(MS002.ENDTIME)
				 FROM ASUTL.MS001_OPERS_ADD MS001_ADD
				 INNER JOIN ASUTL.MS002_OP_STRS MS002 ON MS002.MS001_ID = MS001_ADD.MS001_ID
				 WHERE MS001_ADD.REF013_ID IS NOT NULL
				   AND MS002.ENDTIME >= MS012.BEGTIME
				   AND MS002.ENDTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS002.CAR001_ID = MS012.CAR001_ID) AS UNLOADING_DATE,
				(SELECT MAX(MS021.OP004_ID)
				 FROM ASUTL.MS021_CAR_DOCS MS021
				 WHERE MS021.MS012_ID = MS012.ID
				   AND MS021.IS_EXT_DOC = 1) AS OUTER_INVOICE_ID,
				(SELECT MAX(MS002.ID)
				 FROM ASUTL.MS002_OP_STRS MS002
				 INNER JOIN ASUTL.MS001_OPERS MS001 ON MS001.ID = MS002.MS001_ID
				 INNER JOIN ASUTL.REF012_OPERATION_TYPES REF012 ON REF012.ID = MS001.REF012_ID AND (REF012.CH_TECH_FAULT = 1 OR REF012.CH_COMM_FAULT = 1)
				 WHERE MS002.ENDTIME >= MS012.BEGTIME
				   AND MS002.ENDTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS002.CAR001_ID = MS012.CAR001_ID) AS SPOIL_LINE_ID,
				(SELECT MIN(CCH.HISTORY_ID)
				 FROM XX_USER.XX_CAR_CARD_HISTORY CCH
				 WHERE CCH.UPDATE_DATE >= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND CCH.CAR001_ID = MS012.CAR001_ID) AS CARD_HISTORY_ID,
				(SELECT MAX(MS020.ID)
				 FROM ASUTL.MS020_CAR_FREIGHT_HISTS MS020
				 WHERE MS020.BEGTIME >= MS012.BEGTIME
				   AND MS020.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS020.CAR001_ID = MS012.CAR001_ID) AS FREIGHT_LINE_ID,
				(SELECT MAX(MS002.ENDTIME)
				 FROM ASUTL.MS002_OP_STRS MS002
				 INNER JOIN ASUTL.MS001_OPERS MS001 ON MS001.ID = MS002.MS001_ID AND MS001.REF012_ID = 63 -- ПОДГОТОВКА ВАГОНОВ
				 WHERE MS002.ENDTIME >= MS012.BEGTIME
				   AND MS002.ENDTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS002.CAR001_ID = MS012.CAR001_ID) AS PREPARE_DATE,
				(SELECT MAX(MS052.MS050_ID) KEEP(DENSE_RANK LAST ORDER BY MS052.BEGTIME)
				 FROM ASUTL.MS052_TASK_STRS MS052
				 WHERE MS052.BEGTIME >= MS012.BEGTIME
				   AND MS052.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS052.CAR001_ID = MS012.CAR001_ID) AS DAILY_TASK_ID,
				(SELECT MAX(MS002.MS001_ID)
				 FROM ASUTL.MS002_OP_STRS MS002
				 WHERE MS002.ENDTIME >= MS012.BEGTIME
				   AND MS002.ENDTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS002.CAR001_ID = MS012.CAR001_ID) AS LAST_ACTION_HEADER_ID,
				(SELECT MAX(MS011.REF009_ID_CURR) KEEP(DENSE_RANK LAST ORDER BY MS011.D_FROM)
				 FROM ASUTL.MS011_CAR_POSITION_WAYS MS011
				 WHERE MS011.D_FROM >= MS012.BEGTIME
				   AND MS011.D_FROM <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS011.CAR001_ID = MS012.CAR001_ID) AS FRONT_ID
			FROM ASUTL.MS012_CAR_LIFE_CYCLE MS012
			INNER JOIN ASUTL.CAR001_CARS CAR001 ON CAR001.ID = MS012.CAR001_ID
			LEFT JOIN ASUTL.NSI107_CAR_KIND NSI107 ON NSI107.ID = CAR001.NSI107_ID
			LEFT JOIN ASUTL.REF031_REF029_NSI107 REF031 ON REF031.NSI107_ETRAN_ID = NSI107.ETRAN_ID
			WHERE MS012.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
			  AND MS012.ENDTIME >= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
			  AND NVL(REF031.REF029_ID, 0) = NVL($UnitType, NVL(REF031.REF029_ID, 0))
		) CAR
		-- ########## --
		INNER JOIN ASUTL.MS002_OP_STRS FIRST_MS002 ON FIRST_MS002.MS001_ID = CAR.MS001_FIRST_ID AND FIRST_MS002.CAR001_ID = CAR.CAR_ID
		LEFT JOIN ASUTL.NSI008_FREIGHT FIRST_NSI008 ON FIRST_NSI008.ID = FIRST_MS002.NSI008_ID
		-- ########## --
		LEFT JOIN ASUTL.OP030_INVOICE OUTER_OP030 ON OUTER_OP030.ID = CAR.OUTER_INVOICE_ID
		LEFT JOIN ASUTL.NSI005_STATION OUTER_NSI005 ON OUTER_NSI005.ID = OUTER_OP030.NSI005_FROMSTATION_ID
		-- ########## --
		LEFT JOIN ASUTL.MS050_TASKS MS050 ON MS050.ID = CAR.DAILY_TASK_ID
		LEFT JOIN ASUTL.NSI005_STATION NSI005 ON NSI005.ID = MS050.NSI005_ID_TOSTATION
		LEFT JOIN ASUTL.HR003_DEPTS HR003 ON HR003.ID = MS050.HR003_ID
		-- ########## --
		LEFT JOIN ASUTL.MS020_CAR_FREIGHT_HISTS MS020 ON MS020.ID = CAR.FREIGHT_LINE_ID
		LEFT JOIN ASUTL.REF020_ENTERPRISE_FREIGHT REF020 ON REF020.ID = MS020.REF020_ID
		LEFT JOIN ASUTL.MS002_OP_STRS MS002 ON MS002.ID = MS020.MS002_ID
		-- ########## --
		INNER JOIN ASUTL.MS003_CAR_STATE_HISTORY MS003 ON MS003.CAR001_ID = CAR.CAR_ID AND MS003.MS001_ID = CAR.LAST_ACTION_HEADER_ID AND MS003.MS001_STATUS = 2
		INNER JOIN ASUTL.MS001_OPERS MS001 ON MS001.ID = MS003.MS001_ID AND MS001.STATUS = MS003.MS001_STATUS
		LEFT JOIN ASUTL.REF036_CAT_FREIGHT_LOAD REF036 ON REF036.ID = MS003.REF036_ID
		LEFT JOIN XX_USER.XX_CAR_CARD_HISTORY CCH ON CCH.HISTORY_ID = CAR.CARD_HISTORY_ID
		LEFT JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = MS003.NSI008_ID
		LEFT JOIN ASUTL.REF009_WAY_FRONTS REF009 ON REF009.ID = CAR.FRONT_ID
		LEFT JOIN ASUTL.CNT001_HOZ_SUBJECTS CNT001 ON CNT001.ID = NVL2(CAR.CARD_HISTORY_ID, CCH.CNT001_OWNER_ID, CAR.CAR_OWNER_ID)
		
		UNION ALL
		
		SELECT
		LN.CONT_NUMBER  as CONT_NUMBER,
			REF009.NAME AS FRONT_NAME,
			NSI008.NAME AS CARGO_ETSNG_NAME,
			REF020.NAME AS CARGO_FULL_NAME,
			TO_CHAR(NVL(MS032.WEIGHT_FREIGHT, 0), '999G999G990D999') AS CARGO_WEIGHT_NETTO,
			NSI005.SHORT_NAME AS DESTINATION_STATION_NAME,
			TO_CHAR(MS031.ENDTIME, 'DD.MM.YYYY HH24:MI') AS LOADING_DATE,
			TO_CHAR(LN.COMING_DATE, 'DD.MM.YYYY HH24:MI') AS COMING_DATE,
			TO_CHAR(MS032.BEGTIME, 'DD.MM.YYYY HH24:MI') AS ACTION_DATE,
			NULL AS PREPARE_DATE,
			MS050.NOTES AS DAILY_TASK_NOTE,
			NULL AS UNIT_ONE_NOTE,
			LN.DAILY_TASK_ID,
			NULL AS UNIT_OWNER_NAME,
			NULL AS UNIT_VOLUME,
			NULL AS FLAW_NAME,
			NULL AS FAULT_NAME,
			FIRST_NSI008.NAME AS FCARGO_ETSNG_NAME,
			
			TO_CHAR(NVL(FIRST_MS031.WEIGHT_FREIGHT, 0), '999G999G990D999') AS FCARGO_WEIGHT_NETTO,
			OUTER_NSI005.SHORT_NAME AS DEPARTURE_STATION_NAME,
			OUTER_OP030.SENDER_NAME AS SHIPPER_NAME,
			TO_CHAR(LN.UNLOADING_DATE, 'DD.MM.YYYY HH24:MI') AS UNLOADING_DATE,
			
			-- ########## --
			NULL AS CONT_WALKING_ID,
			LN.CONT_TYPE_ID,
			CASE WHEN (NVL(MS032.WEIGHT_FREIGHT, 0) > 0)
				THEN CASE
					WHEN (MS032.REF025_ID = 40) THEN 'ПОД_ВЫГР'
					WHEN (MS032.REF025_ID = 27) THEN 'СДАЧА'
					WHEN (MS050.TRANSFER_TP = 0) AND (MS032.REF025_ID != 27) AND (MS030.REF012_ID != 101) THEN 'С_ДОК'
					WHEN (MS050.TRANSFER_TP = 2) AND (MS032.REF025_ID != 27) AND (MS030.REF012_ID != 101) THEN 'СКЛАД'
					ELSE NULL END
				ELSE CASE WHEN (LN.DAILY_TASK_ID IS NOT NULL) AND (MS032.REF025_ID = 40) THEN 'ПОД_ПОГР'
						  WHEN (MS032.REF025_ID != 40) THEN 'ГОТ_ПОГР'
						  ELSE NULL END
				END AS ACTION_TYPE,
			CASE WHEN (NVL(MS032.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS WEIGHT_SIGN,
			CASE WHEN (NVL(FIRST_MS031.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS FWEIGHT_SIGN,
			NULL AS ORGANIZATION_ID,
			CASE WHEN (XX_USER.CUSTOMER_PKG.CHECK_PARTY_CURRENT(LN.CONT_OWNER_ID) = 1) THEN 'СОБ' ELSE 'ЧУЖ' END AS CONT_OWNER_SIGN,
			'CONT' AS UNIT_TYPE_CODE,
			NVL(MS032.REF036_ID, $ProductCategory) AS CARGO_CATEGORY_ID,
			$RawCategory AS FCARGO_CATEGORY_ID,
			LN.UNIT_LENGTH
		FROM (
			SELECT
				CAR025.CONT_NUMBER,
				CAR025.ID AS CONT_ID,
				MS033.MS030_FIRST_ID,
				$ContTypeId AS CONT_TYPE_ID,
				CAR025.CNT001_ID AS CONT_OWNER_ID,
				NSI015.WIDTH_F AS UNIT_LENGTH,
				MS033.BEGTIME AS COMING_DATE,
				(SELECT MAX(MS031.ENDTIME)
				 FROM ASUTL.MS031_CONT_OP_STRS MS031
				 INNER JOIN ASUTL.MS030_CONT_OPERS MS030 ON MS030.ID = MS031.MS030_ID
				 INNER JOIN ASUTL.REF012_OPERATION_TYPES REF012 ON REF012.ID = MS030.REF012_ID
				 WHERE REF012.ID = 106 -- ВЫГРУЗКА КОНТЕЙНЕРА НА ВАГОНЕ
				   AND MS031.ENDTIME >= MS033.BEGTIME
				   AND MS031.ENDTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS031.CAR025_ID = CAR025.ID) AS UNLOADING_DATE,
				(SELECT MAX(MS038.OP004_ID)
				 FROM ASUTL.MS038_CONT_DOCS MS038
				 WHERE MS038.MS033_ID = MS033.ID
				   AND MS038.IS_EXT_DOC = 1) AS OUTER_INVOICE_ID,
				(SELECT MAX(MS037.ID)
				 FROM ASUTL.MS037_CONT_FREIGHT_HISTS MS037
				 WHERE MS037.BEGTIME >= MS033.BEGTIME
				   AND MS037.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS037.CAR025_ID = CAR025.ID) AS FREIGHT_LINE_ID,
				(SELECT MAX(MS063.MS050_ID) KEEP(DENSE_RANK LAST ORDER BY MS063.BEGTIME)
				 FROM ASUTL.MS063_TASK_CONT MS063
				 WHERE MS063.BEGTIME >= MS033.BEGTIME
				   AND MS063.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS063.CAR025_ID = CAR025.ID) AS DAILY_TASK_ID,
				(SELECT MAX(MS032.ID)
				 FROM ASUTL.MS032_CONT_STATE_HISTORY MS032
				 WHERE MS032.BEGTIME >= MS033.BEGTIME
				   AND MS032.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS032.MS030_STATUS = 2
				   AND MS032.CAR025_ID = CAR025.ID) AS LAST_HISTORY_ID,
				(SELECT MAX(MS034.REF009_ID) KEEP(DENSE_RANK LAST ORDER BY MS034.D_FROM)
				 FROM ASUTL.MS034_CONT_POSITIONS MS034
				 WHERE MS034.D_FROM >= MS033.BEGTIME
				   AND MS034.D_FROM <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
				   AND MS034.CAR025_ID = CAR025.ID) AS FRONT_ID
			FROM ASUTL.MS033_CONT_LIFE_CYCLE MS033
			INNER JOIN ASUTL.CAR025_CONTAINERS CAR025 ON CAR025.ID = MS033.CAR025_ID
			INNER JOIN ASUTL.NSI014_CONT_TYPE_BIG NSI014 ON NSI014.ID = CAR025.NSI014_ID
			LEFT JOIN ASUTL.NSI015_CONT_SIZE_BIG NSI015 ON NSI015.ID = CAR025.NSI015_ID
			WHERE MS033.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
			  AND MS033.ENDTIME >= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
		) LN
		-- ########## --
		INNER JOIN ASUTL.MS031_CONT_OP_STRS FIRST_MS031 ON FIRST_MS031.MS030_ID = LN.MS030_FIRST_ID AND FIRST_MS031.CAR025_ID = LN.CONT_ID
		LEFT JOIN ASUTL.NSI008_FREIGHT FIRST_NSI008 ON FIRST_NSI008.ID = FIRST_MS031.NSI008_ID
		-- ########## --
		LEFT JOIN ASUTL.OP030_INVOICE OUTER_OP030 ON OUTER_OP030.ID = LN.OUTER_INVOICE_ID
		LEFT JOIN ASUTL.NSI005_STATION OUTER_NSI005 ON OUTER_NSI005.ID = OUTER_OP030.NSI005_FROMSTATION_ID
		-- ########## --
		LEFT JOIN ASUTL.MS050_TASKS MS050 ON MS050.ID = LN.DAILY_TASK_ID
		LEFT JOIN ASUTL.OP011_OTPR OP011 ON OP011.ID = MS050.OP011_ID
		LEFT JOIN ASUTL.NSI005_STATION NSI005 ON NSI005.ID = OP011.NSI005_TOSTATION_ID
		-- ########## --
		LEFT JOIN ASUTL.MS037_CONT_FREIGHT_HISTS MS037 ON MS037.ID = LN.FREIGHT_LINE_ID
		LEFT JOIN ASUTL.REF020_ENTERPRISE_FREIGHT REF020 ON REF020.ID = MS037.REF020_ID
		LEFT JOIN ASUTL.MS031_CONT_OP_STRS MS031 ON MS031.ID = MS037.MS031_ID
		-- ########## --
		INNER JOIN ASUTL.MS032_CONT_STATE_HISTORY MS032 ON MS032.ID = LN.LAST_HISTORY_ID
		INNER JOIN ASUTL.MS030_CONT_OPERS MS030 ON MS030.ID = MS032.MS030_ID AND MS030.STATUS = MS032.MS030_STATUS
		LEFT JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = MS032.NSI008_ID
		LEFT JOIN ASUTL.REF009_WAY_FRONTS REF009 ON REF009.ID = LN.FRONT_ID
		WHERE LN.CONT_TYPE_ID = NVL($UnitType, LN.CONT_TYPE_ID)
	";
	
	$sql_script02 = "
		SELECT
			CAR.CAR_NUMBER,
			TO_CHAR(MS002.ENDTIME, 'DD.MM.YYYY HH24:MI') AS LOADING_DATE,
			TO_CHAR(CAR.CYCLE_BEGIN_DATE, 'DD.MM.YYYY HH24:MI') AS COMING_DATE,
			TO_CHAR(CAR.ACTION_DATE, 'DD.MM.YYYY HH24:MI') AS ACTION_DATE,
			TO_CHAR(NVL(MS003.WEIGHT_FREIGHT, 0), '999G999G990D999') AS CARGO_WEIGHT_NETTO,
			NSI008.NAME AS CARGO_ETSNG_NAME,
			REF020.NAME AS CARGO_FULL_NAME,

			-- ########## Добавление станции назначения из последней накладной-- 
			nvl(NSI005.SHORT_NAME, NSI005_TO.SHORT_NAME) AS DESTINATION_STATION_NAME,

			OP030_IN.SENDER_NAME AS SHIPPER_NAME,
			NVL2(CAR.CARD_HISTORY_ID, CCH.NOTE, CAR.CAR_ONE_NOTE) AS UNIT_ONE_NOTE,
			CNT001.CODE AS UNIT_OWNER_NAME,
			FIRST_NSI008.NAME AS FCARGO_ETSNG_NAME,
			
			TO_CHAR(NVL(FIRST_MS002.WEIGHT_FREIGHT, 0), '999G999G990D999') AS FCARGO_WEIGHT_NETTO,
			OUTER_NSI005.SHORT_NAME AS DEPARTURE_STATION_NAME,
			
			-- ########## --
			CAR.CAR_TYPE_ID,
			CAR.ACTION_TYPE,
			CASE WHEN (NVL(MS003.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS WEIGHT_SIGN,
			CASE WHEN (NVL(FIRST_MS002.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS FWEIGHT_SIGN,
			$Org AS ORGANIZATION_ID,
			'CAR' AS UNIT_TYPE_CODE,
			$Owner AS CAR_OWNER_SIGN,
			MS003.SENDING_DIR AS CAR_WALKING_ID,
			NVL(MS003.REF036_ID, $ProductCategory) AS CARGO_CATEGORY_ID,
			$RawCategory AS FCARGO_CATEGORY_ID,
			NULL AS UNIT_LENGTH
		FROM (
			SELECT
				LINE.CAR_NUMBER,
				LINE.CAR_ID,
				LINE.ACTION_HEADER_ID,
				LINE.CAR_TYPE_ID,
				LINE.MS001_FIRST_ID,
				LINE.ACTION_DATE,
				CASE LINE.ACTION_TYPE
					WHEN 59 THEN 'ВЫГР'
					WHEN 58 THEN 'ПОГР'
					WHEN 90 THEN 'РЕГИСТР'
					WHEN 101 THEN 'ПРИЕМ_СОСТ'
					ELSE NULL END AS ACTION_TYPE,
				LINE.CAR_OWNER_ID,
				LINE.CAR_ONE_NOTE,
				LINE.CAR_GROUP_ID,
				LINE.CYCLE_BEGIN_DATE,
				(SELECT MIN(CCH.HISTORY_ID)
				 FROM XX_USER.XX_CAR_CARD_HISTORY CCH
				 WHERE CCH.UPDATE_DATE >= LINE.ACTION_DATE
				   AND CCH.CAR001_ID = LINE.CAR_ID) AS CARD_HISTORY_ID,
				(SELECT MAX(MS021.OP004_ID)
				 FROM ASUTL.MS021_CAR_DOCS MS021
				 WHERE MS021.MS012_ID = LINE.LIFE_CYCLE_ID
				   AND MS021.IS_EXT_DOC = 1) AS INVOICE_INCOMING_ID,
				(SELECT MAX(MS020.ID)
				 FROM ASUTL.MS020_CAR_FREIGHT_HISTS MS020
				 WHERE MS020.BEGTIME >= LINE.CYCLE_BEGIN_DATE
				   AND MS020.BEGTIME <= LINE.ACTION_DATE
				   AND MS020.CAR001_ID = LINE.CAR_ID) AS FREIGHT_LINE_ID,
				(SELECT MAX(MS052.MS050_ID) KEEP(DENSE_RANK LAST ORDER BY MS052.BEGTIME)
				 FROM ASUTL.MS052_TASK_STRS MS052
				 WHERE MS052.BEGTIME >= LINE.CYCLE_BEGIN_DATE
				   AND MS052.BEGTIME <= LINE.ACTION_DATE
				   AND MS052.CAR001_ID = LINE.CAR_ID) AS DAILY_TASK_ID,
				LINE.ACTION_FRONT_ID
			FROM (
				SELECT
					MAX(MS001.ID) KEEP(DENSE_RANK LAST ORDER BY MS001.ENDTIME) AS ACTION_HEADER_ID,
					MAX(MS001.REF009_ID) KEEP(DENSE_RANK LAST ORDER BY MS001.ENDTIME) AS ACTION_FRONT_ID,
					MAX(MS001.ENDTIME) AS ACTION_DATE,
					MS012.ID as LIFE_CYCLE_ID,
					MS012.BEGTIME as CYCLE_BEGIN_DATE,
					MS012.MS001_FIRST_ID,
					MS001.REF012_ID AS ACTION_TYPE,
					CAR001.CAR_NUMBER,
					CAR001.NOTE AS CAR_ONE_NOTE,
					CAR001.CNT001_OWNER_ID AS CAR_OWNER_ID,
					CAR001.CAR002_ID AS CAR_GROUP_ID,
					MS002.CAR001_ID AS CAR_ID,
					REF031.REF029_ID AS CAR_TYPE_ID
				FROM ASUTL.MS001_OPERS MS001
				INNER JOIN ASUTL.MS002_OP_STRS MS002 ON MS002.MS001_ID = MS001.ID
				LEFT JOIN ASUTL.MS002_OP_STRS_ADD MS002_ADD ON MS002_ADD.MS002_ID = MS002.ID
				INNER JOIN ASUTL.MS012_CAR_LIFE_CYCLE MS012 ON MS012.CAR001_ID = MS002.CAR001_ID AND MS001.ENDTIME BETWEEN MS012.BEGTIME AND MS012.ENDTIME
				INNER JOIN ASUTL.CAR001_CARS CAR001 ON CAR001.ID = MS002.CAR001_ID
				LEFT JOIN ASUTL.NSI107_CAR_KIND NSI107 ON NSI107.ID = CAR001.NSI107_ID
				LEFT JOIN ASUTL.REF031_REF029_NSI107 REF031 ON REF031.NSI107_ETRAN_ID = NSI107.ETRAN_ID
				WHERE MS001.REF012_ID IN (59, 58, 90, 101)
				  AND MS001.ENDTIME >= TO_DATE(:pStartDate, 'DD.MM.YYYY HH24:MI:SS')
				  AND MS001.ENDTIME <= TO_DATE(:pEndDate, 'DD.MM.YYYY HH24:MI:SS')
				  AND (CASE WHEN (MS001.REF012_ID = 101) THEN NVL(MS002_ADD.ACCEPT_FLAG, 0) ELSE 1 END) = 1 -- ПРИЗНАК ПРИЕМА К ПЕРЕВОЗКЕ
				  AND MS001.STATUS = 2 -- ПРИЗНАК ВЫПОЛНЕНИЯ ОПЕРАЦИИ
				  AND NVL(REF031.REF029_ID, 0) = NVL($UnitType, NVL(REF031.REF029_ID, 0))
				GROUP BY
					MS001.REF012_ID, CAR001.CAR_NUMBER, MS002.CAR001_ID, REF031.REF029_ID, CAR001.CNT001_OWNER_ID,
					CAR001.CAR002_ID, MS012.BEGTIME, MS012.ID, MS012.MS001_FIRST_ID, CAR001.NOTE
			) LINE
		) CAR
		-- ########## --
		INNER JOIN ASUTL.MS002_OP_STRS FIRST_MS002 ON FIRST_MS002.MS001_ID = CAR.MS001_FIRST_ID AND FIRST_MS002.CAR001_ID = CAR.CAR_ID
		LEFT JOIN ASUTL.NSI008_FREIGHT FIRST_NSI008 ON FIRST_NSI008.ID = FIRST_MS002.NSI008_ID
		-- ########## --
		INNER JOIN ASUTL.MS003_CAR_STATE_HISTORY MS003 ON MS003.CAR001_ID = CAR.CAR_ID AND MS003.MS001_ID = CAR.ACTION_HEADER_ID AND MS003.MS001_STATUS = 2
		LEFT JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = MS003.NSI008_ID
		LEFT JOIN ASUTL.REF036_CAT_FREIGHT_LOAD REF036 ON REF036.ID = MS003.REF036_ID
		-- ########## --
		LEFT JOIN ASUTL.OP030_INVOICE OP030_IN ON OP030_IN.ID = CAR.INVOICE_INCOMING_ID
		LEFT JOIN ASUTL.NSI005_STATION OUTER_NSI005 ON OUTER_NSI005.ID = OP030_IN.NSI005_FROMSTATION_ID
		-- ########## --
		LEFT JOIN ASUTL.MS050_TASKS MS050 ON MS050.ID = CAR.DAILY_TASK_ID
		LEFT JOIN ASUTL.NSI005_STATION NSI005 ON NSI005.ID = MS050.NSI005_ID_TOSTATION
		-- ########## Добавление станции назначения из последней накладной-- 
		LEFT JOIN (
										SELECT
										op031.car_number,
										MAX(op030.id) AS mid
										FROM
										asutl.op030_invoice op030,
										asutl.op031_car op031
										WHERE
										op030.id = op031.op030_id
										and op030.nsi005_fromstation_id = 270284
										GROUP BY
										op031.car_number ) max_op030 ON max_op030.car_number =  car.car_number

		LEFT JOIN asutl.op030_invoice op030_to on max_op030.mid = op030_to.id
		LEFT JOIN asutl.nsi005_station nsi005_to ON nsi005_to.id = op030_to.nsi005_tostation_id
-- ########## --
		LEFT JOIN ASUTL.MS020_CAR_FREIGHT_HISTS MS020 ON MS020.ID = CAR.FREIGHT_LINE_ID
		LEFT JOIN ASUTL.REF020_ENTERPRISE_FREIGHT REF020 ON REF020.ID = MS020.REF020_ID
		-- ########## --
		LEFT JOIN ASUTL.MS002_OP_STRS MS002 ON MS002.ID = MS020.MS002_ID
		LEFT JOIN ASUTL.MS001_OPERS MS001_LOAD ON MS001_LOAD.ID = MS002.MS001_ID
		-- ########## --
		LEFT JOIN ASUTL.REF009_WAY_FRONTS REF009 ON REF009.ID = NVL(CAR.ACTION_FRONT_ID, MS001_LOAD.REF009_ID)
		LEFT JOIN ASUTL.HR003_DEPTS HR003 ON HR003.ID = REF009.HR003_ID
		-- ########## --
		LEFT JOIN XX_USER.XX_CAR_CARD_HISTORY CCH ON CCH.HISTORY_ID = CAR.CARD_HISTORY_ID
		LEFT JOIN ASUTL.CNT001_HOZ_SUBJECTS CNT001 ON CNT001.ID = NVL2(CAR.CARD_HISTORY_ID, CCH.CNT001_OWNER_ID, CAR.CAR_OWNER_ID)
		
		UNION ALL
		
		SELECT
		CONT.CONT_NUMBER  as CONT_NUMBER,
			TO_CHAR(MS031.ENDTIME, 'DD.MM.YYYY HH24:MI') AS LOADING_DATE,
			TO_CHAR(CONT.CYCLE_BEGIN_DATE, 'DD.MM.YYYY HH24:MI') AS COMING_DATE,
			TO_CHAR(CONT.ACTION_DATE, 'DD.MM.YYYY HH24:MI') AS ACTION_DATE,
			CONT.CARGO_WEIGHT_NETTO,
			NSI008.NAME AS CARGO_ETSNG_NAME,
			REF020.NAME AS CARGO_FULL_NAME,
			NSI005.SHORT_NAME AS DESTINATION_STATION_NAME,
			OP030.SENDER_NAME AS SHIPPER_NAME,
			NULL AS UNIT_ONE_NOTE,
			NULL AS UNIT_OWNER_NAME,
			FIRST_NSI008.NAME AS FCARGO_ETSNG_NAME,
			
			TO_CHAR(NVL(FIRST_MS031.WEIGHT_FREIGHT, 0), '999G999G990D999') AS FCARGO_WEIGHT_NETTO,
			OUTER_NSI005.SHORT_NAME AS DEPARTURE_STATION_NAME,
			
			-- ########## --
			CONT.CONT_TYPE_ID,
			CONT.ACTION_TYPE,
			CONT.WEIGHT_SIGN,
			CASE WHEN (NVL(FIRST_MS031.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS FWEIGHT_SIGN,
			CONT.ORGANIZATION_ID,
			'CONT' AS UNIT_TYPE_CODE,
			CONT.CONT_OWNER_SIGN,
			CONT.CONT_WALKING_ID,
			NVL(CONT.CARGO_CATEGORY_ID, $ProductCategory) as CARGO_CATEGORY_ID,
			$RawCategory AS FCARGO_CATEGORY_ID,
			CONT.UNIT_LENGTH
		FROM (
			SELECT
				LN.CONT_NUMBER,
				LN.CONT_TYPE_ID,
				LN.ACTION_TYPE,
				LN.ACTION_DATE,
				LN.MS030_FIRST_ID,
				LN.CONT_ID,
				MS032.NSI008_ID AS FREIGHT_ETSNG_ID,
				TO_CHAR(NVL(MS032.WEIGHT_FREIGHT, 0), '999G999G990D999') AS CARGO_WEIGHT_NETTO,
				CASE WHEN (NVL(MS032.WEIGHT_FREIGHT, 0) <= 0) THEN 0 ELSE 1 END AS WEIGHT_SIGN,
				NULL AS ORGANIZATION_ID,
				CASE WHEN (XX_USER.CUSTOMER_PKG.CHECK_PARTY_CURRENT(LN.CONT_OWNER_ID) = 1) THEN 'СОБ' ELSE 'ЧУЖ' END AS CONT_OWNER_SIGN,
				NULL AS CONT_WALKING_ID,
				MS032.REF036_ID AS CARGO_CATEGORY_ID,
				LN.CYCLE_BEGIN_DATE,
				LN.UNIT_LENGTH,
				(SELECT MAX(MS038.OP004_ID)
				 FROM ASUTL.MS038_CONT_DOCS MS038
				 WHERE MS038.MS033_ID = LN.LIFE_CYCLE_ID
				  AND MS038.IS_EXT_DOC = 1) AS INVOICE_HEADER_ID,
				(SELECT MAX(MS037.ID)
				 FROM ASUTL.MS037_CONT_FREIGHT_HISTS MS037
				 WHERE MS037.BEGTIME >= LN.CYCLE_BEGIN_DATE
				   AND MS037.BEGTIME <= LN.ACTION_DATE
				   AND MS037.CAR025_ID = LN.CONT_ID) AS FREIGHT_LINE_ID,
				(SELECT MAX(MS063.MS050_ID) KEEP(DENSE_RANK LAST ORDER BY MS063.BEGTIME)
				 FROM ASUTL.MS063_TASK_CONT MS063
				 WHERE MS063.BEGTIME >= LN.CYCLE_BEGIN_DATE
				   AND MS063.BEGTIME <= LN.ACTION_DATE
				   AND MS063.CAR025_ID = LN.CONT_ID) AS DAILY_TASK_ID
			FROM (
				SELECT
					MAX(MS030.ID) KEEP(DENSE_RANK LAST ORDER BY MS030.ENDTIME) AS ACTION_HEADER_ID,
					MAX(MS030.ENDTIME) AS ACTION_DATE,
					MS033.ID as LIFE_CYCLE_ID,
					MS033.BEGTIME as CYCLE_BEGIN_DATE,
					MS033.MS030_FIRST_ID,
					NSI015.WIDTH_F AS UNIT_LENGTH,
					CASE
						WHEN (MS030.REF012_ID IN (144, 106, 59, 107)) THEN 'ВЫГР'
						WHEN (MS030.REF012_ID IN (58, 110, 111)) THEN 'ПОГР'
						WHEN (MS030.REF012_ID = 90) THEN 'РЕГИСТР'
						WHEN (MS030.REF012_ID = 101) THEN 'ПРИЕМ_СОСТ'
						ELSE NULL END AS ACTION_TYPE,
					CAR025.CONT_NUMBER,
					CAR025.CNT001_ID AS CONT_OWNER_ID,
					CAR025.ID AS CONT_ID,
					$ContTypeId AS CONT_TYPE_ID
				FROM ASUTL.MS030_CONT_OPERS MS030
				INNER JOIN ASUTL.MS031_CONT_OP_STRS MS031 ON MS031.MS030_ID = MS030.ID
				INNER JOIN ASUTL.CAR025_CONTAINERS CAR025 ON CAR025.ID = MS031.CAR025_ID
				INNER JOIN ASUTL.NSI014_CONT_TYPE_BIG NSI014 ON NSI014.ID = CAR025.NSI014_ID
				INNER JOIN ASUTL.MS033_CONT_LIFE_CYCLE MS033 ON MS033.CAR025_ID = MS031.CAR025_ID AND MS030.ENDTIME BETWEEN MS033.BEGTIME AND MS033.ENDTIME
				LEFT JOIN ASUTL.MS031_CONT_OP_STRS_ADD MS031_ADD ON MS031_ADD.MS031_ID = MS031.ID
				LEFT JOIN ASUTL.NSI015_CONT_SIZE_BIG NSI015 ON NSI015.ID = CAR025.NSI015_ID
				WHERE MS030.REF012_ID IN (58, 110, 111, 90, 101, 144, 106, 59, 107)
				  AND MS030.ENDTIME >= TO_DATE(:pStartDate, 'DD.MM.YYYY HH24:MI:SS')
				  AND MS030.ENDTIME <= TO_DATE(:pEndDate, 'DD.MM.YYYY HH24:MI:SS')
				  AND (CASE WHEN (MS030.REF012_ID = 101) THEN NVL(MS031_ADD.ACCEPT_FLAG, 0) ELSE 1 END) = 1 -- ПРИЗНАК ПРИЕМА К ПЕРЕВОЗКЕ
				  AND MS030.STATUS = 2 -- ПРИЗНАК ВЫПОЛНЕНИЯ ОПЕРАЦИИ
				GROUP BY
					CAR025.CONT_NUMBER, CAR025.CNT001_ID, CAR025.ID, CAR025.NSI014_ID, MS030.REF012_ID, NSI014.TYPE_NAME,
					NSI015.WIDTH_F, MS033.BEGTIME, MS033.ID, MS033.MS030_FIRST_ID
			) LN
			-- ########## --
			INNER JOIN ASUTL.MS032_CONT_STATE_HISTORY MS032 ON MS032.CAR025_ID = LN.CONT_ID AND MS032.MS030_ID = LN.ACTION_HEADER_ID AND MS032.MS030_STATUS = 2
			WHERE LN.CONT_TYPE_ID = NVL($UnitType, LN.CONT_TYPE_ID)
		) CONT
		-- ########## --
		INNER JOIN ASUTL.MS031_CONT_OP_STRS FIRST_MS031 ON FIRST_MS031.MS030_ID = CONT.MS030_FIRST_ID AND FIRST_MS031.CAR025_ID = CONT.CONT_ID
		LEFT JOIN ASUTL.NSI008_FREIGHT FIRST_NSI008 ON FIRST_NSI008.ID = FIRST_MS031.NSI008_ID
		-- ########## --
		LEFT JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = CONT.FREIGHT_ETSNG_ID
		LEFT JOIN ASUTL.OP030_INVOICE OP030 ON OP030.ID = CONT.INVOICE_HEADER_ID
		LEFT JOIN ASUTL.NSI005_STATION OUTER_NSI005 ON OUTER_NSI005.ID = OP030.NSI005_FROMSTATION_ID
		-- ########## --
		LEFT JOIN ASUTL.MS037_CONT_FREIGHT_HISTS MS037 ON MS037.ID = CONT.FREIGHT_LINE_ID
		LEFT JOIN ASUTL.REF020_ENTERPRISE_FREIGHT REF020 ON REF020.ID = MS037.REF020_ID
		LEFT JOIN ASUTL.MS031_CONT_OP_STRS MS031 ON MS031.ID = MS037.MS031_ID
		-- ########## --
		LEFT JOIN ASUTL.MS050_TASKS MS050 ON MS050.ID = CONT.DAILY_TASK_ID
		LEFT JOIN ASUTL.OP011_OTPR OP011 ON OP011.ID = MS050.OP011_ID
		LEFT JOIN ASUTL.NSI005_STATION NSI005 ON NSI005.ID = OP011.NSI005_TOSTATION_ID
	";
	
	// ####################################
	// ############## СЫРЬЕ ###############
	// ####################################
	/*
	$sql_10 = "
		SELECT
			CAR.UNIT_NUMBER,
			--TO_CHAR(CAR.ACTION_DATE, 'DD.MM.YYYY HH24:MI') AS ACTION_DATE,
			--CAR.FIRST_CARGO_WEIGHT,
			--NVL(MS032.WEIGHT_FREIGHT, MS003.WEIGHT_FREIGHT) AS CURRENT_CARGO_WEIGHT,
			-- ########## --
			CAR.UNIT_TYPE_ID,
			CAR.UNIT_TYPE_NAME,
			CAR.FIRST_CARGO_ID,
			CAR.FIRST_CARGO_NAME,
			
			CASE WHEN (NVL(MS032.WEIGHT_FREIGHT, MS003.WEIGHT_FREIGHT) > 0) AND
					  (NVL(MS032.REF025_ID, MS003.REF025_ID) = 40) THEN 'ПОД_ВЫГР' ELSE NULL END AS ACTION_TYPE_NAME,
			
			CASE WHEN (NVL(MS032.WEIGHT_FREIGHT, MS003.WEIGHT_FREIGHT) <= 0) THEN 0 ELSE 1 END AS CURRENT_WEIGHT_SIGN,
			$Owner AS UNIT_OWNER_SIGN
		FROM (
			SELECT
				NVL(CAR025.CONT_NUMBER, CAR001.CAR_NUMBER) AS UNIT_NUMBER,
				--MS012.BEGTIME AS ACTION_DATE,
				CASE WHEN (CAR025.ID IS NULL) THEN REF031.REF029_ID ELSE $ContTypeId END AS UNIT_TYPE_ID,
				CASE WHEN (CAR025.ID IS NULL) THEN REF029.NAME ELSE $ContTypeName END AS UNIT_TYPE_NAME,
				MS012.CAR001_ID AS CAR_ID,
				CAR025.ID AS CONT_ID,
				NSI008.ID AS FIRST_CARGO_ID,
				NSI008.NAME AS FIRST_CARGO_NAME,
				--NVL(CONT_FIRST.WEIGHT_FREIGHT, CAR_FIRST.WEIGHT_FREIGHT) AS FIRST_CARGO_WEIGHT,
				CAR001.CNT001_OWNER_ID AS CAR_OWNER_ID,
				CAR001.CAR002_ID AS CAR_GROUP_ID,
				CASE WHEN (CAR025.ID IS NULL) THEN (
													SELECT MAX(MS002.MS001_ID)
													FROM ASUTL.MS002_OP_STRS MS002
													WHERE MS002.STATUS = 2
													  AND MS002.BEGTIME >= MS012.BEGTIME
													  AND MS002.ENDTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
													  AND MS002.CAR001_ID = MS012.CAR001_ID)
					ELSE NULL END AS LAST_CAR_ACTION_ID,
				CASE WHEN (CAR025.ID IS NOT NULL) THEN (
														SELECT MAX(MS031.MS030_ID)
														FROM ASUTL.MS031_CONT_OP_STRS MS031
														WHERE MS031.STATUS = 2
														  AND MS031.BEGTIME >= MS012.BEGTIME
														  AND MS031.ENDTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
														  AND MS031.CAR025_ID = CAR025.ID)
					ELSE NULL END AS LAST_CONT_ACTION_ID,
				CASE WHEN (CAR025.ID IS NULL) AND (:pDate IS NOT NULL) THEN (
																			SELECT MIN(CCH.HISTORY_ID)
																			FROM XX_USER.XX_CAR_CARD_HISTORY CCH
																			WHERE CCH.UPDATE_DATE >= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
																			AND CCH.CAR001_ID = MS012.CAR001_ID)
					ELSE NULL END AS CARD_HISTORY_ID
			FROM ASUTL.MS012_CAR_LIFE_CYCLE MS012
			INNER JOIN ASUTL.CAR001_CARS CAR001 ON CAR001.ID = MS012.CAR001_ID
			LEFT JOIN ASUTL.NSI107_CAR_KIND NSI107 ON NSI107.ID = CAR001.NSI107_ID
			LEFT JOIN ASUTL.REF031_REF029_NSI107 REF031 ON REF031.NSI107_ETRAN_ID = NSI107.ETRAN_ID
			INNER JOIN ASUTL.REF029_ENT_CAR_TYPES REF029 ON REF029.ID = REF031.REF029_ID
			INNER JOIN ASUTL.MS002_OP_STRS CAR_FIRST ON CAR_FIRST.MS001_ID = MS012.MS001_FIRST_ID AND CAR_FIRST.CAR001_ID = MS012.CAR001_ID
			LEFT JOIN ASUTL.MS031_CONT_OP_STRS CONT_FIRST ON CONT_FIRST.MS002_ID = CAR_FIRST.ID
			LEFT JOIN ASUTL.CAR025_CONTAINERS CAR025 ON CAR025.ID = CONT_FIRST.CAR025_ID
			LEFT JOIN ASUTL.NSI014_CONT_TYPE_BIG NSI014 ON NSI014.ID = CAR025.NSI014_ID
			INNER JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = NVL(CONT_FIRST.NSI008_ID, CAR_FIRST.NSI008_ID)
			WHERE MS012.BEGTIME <= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
			  AND MS012.ENDTIME >= TO_DATE(:pDate, 'DD.MM.YYYY HH24:MI:SS')
			  AND NVL(CONT_FIRST.WEIGHT_FREIGHT, CAR_FIRST.WEIGHT_FREIGHT) > 0
		) CAR
		-- ########## --
		LEFT JOIN XX_USER.XX_CAR_CARD_HISTORY CCH ON CCH.HISTORY_ID = CAR.CARD_HISTORY_ID
		LEFT JOIN ASUTL.MS003_CAR_STATE_HISTORY MS003 ON MS003.CAR001_ID = CAR.CAR_ID AND MS003.MS001_ID = CAR.LAST_CAR_ACTION_ID AND MS003.MS001_STATUS = 2
		LEFT JOIN ASUTL.MS032_CONT_STATE_HISTORY MS032 ON MS032.CAR025_ID = CAR.CONT_ID AND MS032.MS030_ID = LAST_CONT_ACTION_ID AND MS032.MS030_STATUS = 2
		WHERE CAR.UNIT_TYPE_ID = NVL($UnitType, CAR.UNIT_TYPE_ID)
	";
	
	$sql_11 = "
		SELECT
			CAR.UNIT_NUMBER,
			CAR.UNIT_TYPE_ID,
			CAR.UNIT_TYPE_NAME,
			CAR.ACTION_TYPE_NAME,
			TO_CHAR(CAR.ACTION_DATE, 'DD.MM.YYYY HH24:MI') AS ACTION_DATE,
			CAR.FIRST_CARGO_ID,
			CAR.FIRST_CARGO_NAME,
			CAR.FIRST_CARGO_WEIGHT,
			NULL AS CURRENT_WEIGHT_SIGN,
			$Owner AS UNIT_OWNER_SIGN
		FROM (
			SELECT
				LINE.ACTION_DATE,
				LINE.UNIT_NUMBER,
				LINE.UNIT_TYPE_ID,
				LINE.UNIT_TYPE_NAME,
				LINE.FIRST_CARGO_ID,
				LINE.FIRST_CARGO_NAME,
				LINE.FIRST_CARGO_WEIGHT,
				LINE.ACTION_TYPE_NAME,
				LINE.CAR_OWNER_ID,
				LINE.CAR_GROUP_ID,
				CASE WHEN (LINE.CONT_ID IS NULL)
					THEN (SELECT MIN(CCH.HISTORY_ID) FROM XX_USER.XX_CAR_CARD_HISTORY CCH WHERE CCH.UPDATE_DATE >= LINE.ACTION_DATE AND CCH.CAR001_ID = LINE.CAR_ID)
					ELSE NULL END AS CARD_HISTORY_ID
			FROM (
				SELECT
					MAX(MS001.ENDTIME) AS ACTION_DATE,
					NVL(CAR025.CONT_NUMBER, CAR001.CAR_NUMBER) AS UNIT_NUMBER,
					CAR025.ID AS CONT_ID,
					CAR001.ID AS CAR_ID,
					CASE WHEN (CAR025.ID IS NULL) THEN REF031.REF029_ID ELSE $ContTypeId END AS UNIT_TYPE_ID,
					CASE WHEN (CAR025.ID IS NULL) THEN REF029.NAME ELSE $ContTypeName END AS UNIT_TYPE_NAME,
					NSI008.ID AS FIRST_CARGO_ID,
					NSI008.NAME AS FIRST_CARGO_NAME,
					NVL(CONT_FIRST.WEIGHT_FREIGHT, CAR_FIRST.WEIGHT_FREIGHT) AS FIRST_CARGO_WEIGHT,
					MS012.BEGTIME as CYCLE_BEGIN_DATE,
					
					CASE WHEN (MS001.REF012_ID IN (59, 106)) THEN 'ВЫГР'
						WHEN (MS001.REF012_ID = 101) THEN 'СДАНО'
						WHEN (MS001.REF012_ID = 90) THEN 'ПОДАНО'
						ELSE NULL END AS ACTION_TYPE_NAME,
					
					CAR001.CNT001_OWNER_ID AS CAR_OWNER_ID,
					CAR001.CAR002_ID AS CAR_GROUP_ID
				FROM ASUTL.MS001_OPERS MS001
				INNER JOIN ASUTL.MS002_OP_STRS MS002 ON MS002.MS001_ID = MS001.ID
				LEFT JOIN ASUTL.MS002_OP_STRS_ADD MS002_ADD ON MS002_ADD.MS002_ID = MS002.ID
				INNER JOIN ASUTL.CAR001_CARS CAR001 ON CAR001.ID = MS002.CAR001_ID
				INNER JOIN ASUTL.MS012_CAR_LIFE_CYCLE MS012 ON MS012.CAR001_ID = MS002.CAR001_ID AND MS001.ENDTIME BETWEEN MS012.BEGTIME AND MS012.ENDTIME
				LEFT JOIN ASUTL.NSI107_CAR_KIND NSI107 ON NSI107.ID = CAR001.NSI107_ID
				LEFT JOIN ASUTL.REF031_REF029_NSI107 REF031 ON REF031.NSI107_ETRAN_ID = NSI107.ETRAN_ID
				INNER JOIN ASUTL.REF029_ENT_CAR_TYPES REF029 ON REF029.ID = REF031.REF029_ID
				INNER JOIN ASUTL.MS002_OP_STRS CAR_FIRST ON CAR_FIRST.MS001_ID = MS012.MS001_FIRST_ID AND CAR_FIRST.CAR001_ID = MS012.CAR001_ID
				LEFT JOIN ASUTL.MS031_CONT_OP_STRS CONT_FIRST ON CONT_FIRST.MS002_ID = CAR_FIRST.ID
				LEFT JOIN ASUTL.CAR025_CONTAINERS CAR025 ON CAR025.ID = CONT_FIRST.CAR025_ID
				LEFT JOIN ASUTL.NSI014_CONT_TYPE_BIG NSI014 ON NSI014.ID = CAR025.NSI014_ID
				INNER JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = NVL(CONT_FIRST.NSI008_ID, CAR_FIRST.NSI008_ID)
				WHERE MS001.REF012_ID IN (59, 106, 101, 90)
				  AND MS001.ENDTIME >= TO_DATE(:pStartDate, 'DD.MM.YYYY HH24:MI:SS')
				  AND MS001.ENDTIME <= TO_DATE(:pEndDate, 'DD.MM.YYYY HH24:MI:SS')
				  AND (CASE WHEN (MS001.REF012_ID = 101) THEN NVL(MS002_ADD.ACCEPT_FLAG, 0) ELSE 1 END) = 1 -- ПРИЗНАК ПРИЕМА К ПЕРЕВОЗКЕ
				  AND MS001.STATUS = 2 -- ПРИЗНАК ВЫПОЛНЕНИЯ ОПЕРАЦИИ
				  AND NVL(CONT_FIRST.WEIGHT_FREIGHT, CAR_FIRST.WEIGHT_FREIGHT) > 0
				GROUP BY
					REF029.NAME, NSI008.NAME, MS012.BEGTIME, MS001.REF012_ID, CAR001.CAR_NUMBER, CAR025.CONT_NUMBER,
					CAR025.ID, CAR001.ID, REF031.REF029_ID, NSI008.ID, CAR001.CNT001_OWNER_ID, CAR001.CAR002_ID,
					CONT_FIRST.WEIGHT_FREIGHT, CAR_FIRST.WEIGHT_FREIGHT, NSI014.TYPE_NAME
			) LINE
			WHERE LINE.UNIT_TYPE_ID = NVL($UnitType, LINE.UNIT_TYPE_ID)
		) CAR
		LEFT JOIN XX_USER.XX_CAR_CARD_HISTORY CCH ON CCH.HISTORY_ID = CAR.CARD_HISTORY_ID
	";
	
	$sql_12 = "
		SELECT
			CAR.UNIT_NUMBER,
			CAR.INVOICE_NUMBER,
			CAR.FIRST_CARGO_ID,
			CAR.FIRST_CARGO_NAME,
			CAR.UNIT_TYPE_ID,
			CAR.CARGO_WEIGHT,
			CAR.UNIT_TYPE_NAME,
			NULL AS ACTION_TYPE_NAME,
			NULL AS CURRENT_WEIGHT_SIGN,
			CASE WHEN (XX_USER.CUSTOMER_PKG.CHECK_PARTY_CURRENT(CAR.CAR_OWNER_ID) = 1) OR -- СОБСТВЕННИК = КУЙБЫШЕВАЗОТ
					  (CAR.CAR_GROUP_ID = 1) -- ГРУППА ВАГОНА = АРЕНДА
				THEN 'СОБ' ELSE 'ЧУЖ' END AS UNIT_OWNER_SIGN
		FROM (
			SELECT
				NVL(OP035.CONT_NUMBER, CAR001.CAR_NUMBER) AS UNIT_NUMBER,
				OP030.INV_NUMBER AS INVOICE_NUMBER,
				NSI008.ID AS FIRST_CARGO_ID,
				NSI008.NAME AS FIRST_CARGO_NAME,
				NVL(OP035.WEIGHT_NET / 1000, OP031.WEIGHT_NET / 1000) AS CARGO_WEIGHT,
				CAR001.CAR002_ID AS CAR_GROUP_ID,
				NVL(OP031.CNT001_OWNER_ID, CAR001.CNT001_OWNER_ID) AS CAR_OWNER_ID,
				CASE WHEN (OP035.CONT_NUMBER IS NULL) THEN REF029.ID ELSE $ContTypeId END AS UNIT_TYPE_ID,
				CASE WHEN (OP035.CONT_NUMBER IS NULL) THEN REF029.NAME ELSE $ContTypeName END AS UNIT_TYPE_NAME
			FROM XX_USER.XX_FORECAST_COMING XFC
			INNER JOIN ASUTL.CAR001_CARS CAR001 ON CAR001.ID = XFC.CAR_ID
			INNER JOIN ASUTL.NSI005_STATION NSI005 ON NSI005.ID = XFC.DISLOCATION_STATION_ID
			INNER JOIN ASUTL.OP031_CAR OP031 ON OP031.ID = XFC.INVOICE_LINE_ID
			LEFT JOIN ASUTL.OP035_CONT OP035 ON OP035.OP030_ID = OP031.OP030_ID
			LEFT JOIN ASUTL.CAR025_CONTAINERS CAR025 ON CAR025.ID = OP035.CAR025_ID
			LEFT JOIN ASUTL.NSI014_CONT_TYPE_BIG NSI014 ON NSI014.ID = CAR025.NSI014_ID
			INNER JOIN ASUTL.OP030_INVOICE OP030 ON OP030.ID = OP031.OP030_ID
			INNER JOIN ASUTL.OP042_FREIGHT OP042 ON OP042.OP030_ID = OP030.ID
			INNER JOIN ASUTL.NSI008_FREIGHT NSI008 ON NSI008.ID = OP042.NSI008_ID
			LEFT JOIN ASUTL.NSI107_CAR_KIND NSI107 ON NSI107.ID = CAR001.NSI107_ID
			LEFT JOIN ASUTL.REF031_REF029_NSI107 REF031 ON REF031.NSI107_ETRAN_ID = NSI107.ETRAN_ID
			INNER JOIN ASUTL.REF029_ENT_CAR_TYPES REF029 ON REF029.ID = REF031.REF029_ID
			WHERE NVL(OP035.WEIGHT_NET, OP031.WEIGHT_NET) > 0
			  AND NSI005.CODE = 63680 -- ЖИГУЛЕВСКОЕ МОРЕ
			  AND XFC.CLOSING_FLAG IS NULL
		) CAR
		WHERE CAR.UNIT_TYPE_ID = NVL($UnitType, CAR.UNIT_TYPE_ID)
    ";
	*/
?>